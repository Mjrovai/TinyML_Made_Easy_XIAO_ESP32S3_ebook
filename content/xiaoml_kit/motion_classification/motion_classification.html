<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>TinyML Made Easy - Motion Classification and Anomaly Detection</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<link href="../../../content/shared/dsp_spectral_features_block/dsp_spectral_features_block.html" rel="next">
<link href="../../../content/xiaoml_kit/kws/kws.html" rel="prev">
<link href="../../../images/cover.jpg" rel="icon" type="image/jpeg">
<script src="../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../../styles.css">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../../index.html">
    <span class="navbar-title">TinyML Made Easy</span>
    </a>
  </div>
        <div class="quarto-navbar-tools ms-auto tools-wide">
    <a href="https://github.com/Mjrovai/XIAO-ESP32S3-Sense" rel="" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <div class="dropdown">
      <a href="" title="Download" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download"><i class="bi bi-download"></i></a>
      <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="quarto-navigation-tool-dropdown-0">
          <li>
            <a class="dropdown-item quarto-navbar-tools ms-auto-item" href="../../../TinyML-Made-Easy.pdf">
              <i class="bi bi-bi-file-pdf pe-1"></i>
            Download PDF
            </a>
          </li>
          <li>
            <a class="dropdown-item quarto-navbar-tools ms-auto-item" href="../../../TinyML-Made-Easy.epub">
              <i class="bi bi-bi-journal pe-1"></i>
            Download ePub
            </a>
          </li>
      </ul>
    </div>
    <div class="dropdown">
      <a href="" title="Share" id="quarto-navigation-tool-dropdown-1" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Share"><i class="bi bi-share"></i></a>
      <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="quarto-navigation-tool-dropdown-1">
          <li>
            <a class="dropdown-item quarto-navbar-tools ms-auto-item" href="https://twitter.com/intent/tweet?url=|url|">
              <i class="bi bi-bi-twitter pe-1"></i>
            Twitter
            </a>
          </li>
          <li>
            <a class="dropdown-item quarto-navbar-tools ms-auto-item" href="https://www.linkedin.com/sharing/share-offsite/?url=|url|">
              <i class="bi bi-bi-linkedin pe-1"></i>
            LinkedIn
            </a>
          </li>
          <li>
            <a class="dropdown-item quarto-navbar-tools ms-auto-item" href="https://www.facebook.com/sharer/sharer.php?u=|url|">
              <i class="bi bi-bi-facebook pe-1"></i>
            Facebook
            </a>
          </li>
      </ul>
    </div>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../../content/xiaoml_kit/motion_classification/motion_classification.html">Motion Classification and Anomaly Detection</a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../Acknowledgements.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Acknowledgments</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../about_book.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">About this Book</span></a>
  </div>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <span class="sidebar-item-text sidebar-link text-start">
 <span class="menu-text"><div class="part">XIAOML Kit</div></span></span>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../content/xiaoml_kit/setup/setup.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Setup</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../content/xiaoml_kit/image_classification/image_classification.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Image Classification</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../content/xiaoml_kit/object_detection/object_detection.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Object Detection</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../content/xiaoml_kit/kws/kws.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Keyword Spotting (KWS)</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../content/xiaoml_kit/motion_classification/motion_classification.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Motion Classification and Anomaly Detection</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <span class="sidebar-item-text sidebar-link text-start">
 <span class="menu-text"><div class="part">Preprocessing Deepdiving</div></span></span>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../content/shared/dsp_spectral_features_block/dsp_spectral_features_block.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">DSP Spectral Features</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../content/shared/kws_feature_eng/kws_feature_eng.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">KWS Feature Engineering</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <span class="sidebar-item-text sidebar-link text-start">
 <span class="menu-text"><div class="part">Grove Vision AI V2</div></span></span>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../content/grove_vision_ai_v2/setup_and_no_code_apps/setup_and_no_code_apps.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Setup and No-Code Applications</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../content/grove_vision_ai_v2/image_classification/image_classification.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Image Classification</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../content/grove_vision_ai_v2/object_detection/object_detection.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Object Detection</span></a>
  </div>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <span class="sidebar-item-text sidebar-link text-start">
 <span class="menu-text"><div class="part">References &amp; Author</div></span></span>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../about_the_author.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">About the author</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview">Overview</a></li>
  <li><a href="#installing-the-imu" id="toc-installing-the-imu" class="nav-link" data-scroll-target="#installing-the-imu">Installing the IMU</a>
  <ul class="collapse">
  <li><a href="#setting-up-the-hardware" id="toc-setting-up-the-hardware" class="nav-link" data-scroll-target="#setting-up-the-hardware">Setting Up the Hardware</a></li>
  <li><a href="#testing-the-imu-sensor" id="toc-testing-the-imu-sensor" class="nav-link" data-scroll-target="#testing-the-imu-sensor">Testing the IMU Sensor</a></li>
  </ul></li>
  <li><a href="#the-tinyml-motion-classification-project" id="toc-the-tinyml-motion-classification-project" class="nav-link" data-scroll-target="#the-tinyml-motion-classification-project">The TinyML Motion Classification Project</a></li>
  <li><a href="#data-collection" id="toc-data-collection" class="nav-link" data-scroll-target="#data-collection">Data Collection</a>
  <ul class="collapse">
  <li><a href="#preparing-the-data-collection-code" id="toc-preparing-the-data-collection-code" class="nav-link" data-scroll-target="#preparing-the-data-collection-code">Preparing the Data Collection Code</a></li>
  <li><a href="#connecting-to-edge-impulse-for-data-collection" id="toc-connecting-to-edge-impulse-for-data-collection" class="nav-link" data-scroll-target="#connecting-to-edge-impulse-for-data-collection">Connecting to Edge Impulse for Data Collection</a></li>
  </ul></li>
  <li><a href="#data-collection-at-the-studio" id="toc-data-collection-at-the-studio" class="nav-link" data-scroll-target="#data-collection-at-the-studio">Data Collection at the Studio</a>
  <ul class="collapse">
  <li><a href="#movement-simulation" id="toc-movement-simulation" class="nav-link" data-scroll-target="#movement-simulation">Movement Simulation</a></li>
  <li><a href="#data-acquisition" id="toc-data-acquisition" class="nav-link" data-scroll-target="#data-acquisition">Data Acquisition</a></li>
  </ul></li>
  <li><a href="#data-pre-processing" id="toc-data-pre-processing" class="nav-link" data-scroll-target="#data-pre-processing">Data Pre-Processing</a></li>
  <li><a href="#model-design" id="toc-model-design" class="nav-link" data-scroll-target="#model-design">Model Design</a></li>
  <li><a href="#impulse-design" id="toc-impulse-design" class="nav-link" data-scroll-target="#impulse-design">Impulse Design</a></li>
  <li><a href="#generating-features" id="toc-generating-features" class="nav-link" data-scroll-target="#generating-features">Generating features</a></li>
  <li><a href="#training" id="toc-training" class="nav-link" data-scroll-target="#training">Training</a></li>
  <li><a href="#testing" id="toc-testing" class="nav-link" data-scroll-target="#testing">Testing</a></li>
  <li><a href="#deploy" id="toc-deploy" class="nav-link" data-scroll-target="#deploy">Deploy</a></li>
  <li><a href="#inference" id="toc-inference" class="nav-link" data-scroll-target="#inference">Inference</a></li>
  <li><a href="#post-prossessing" id="toc-post-prossessing" class="nav-link" data-scroll-target="#post-prossessing">Post-Prossessing</a></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary">Summary</a></li>
  <li><a href="#resources" id="toc-resources" class="nav-link" data-scroll-target="#resources">Resources</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/Mjrovai/XIAO-ESP32S3-Sense/edit/main/content/xiaoml_kit/motion_classification/motion_classification.qmd" class="toc-action">Edit this page</a></p><p><a href="https://github.com/Mjrovai/XIAO-ESP32S3-Sense/issues/new" class="toc-action">Report an issue</a></p><p><a href="https://github.com/Mjrovai/XIAO-ESP32S3-Sense/blob/main/content/xiaoml_kit/motion_classification/motion_classification.qmd" class="toc-action">View source</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Motion Classification and Anomaly Detection</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/jpeg/ini.jpg" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">DALL·E prompt - 1950s style cartoon illustration set in a vintage audio lab. Scientists, dressed in classic attire with white lab coats, are intently analyzing audio data on large chalkboards. The boards display intricate FFT (Fast Fourier Transform) graphs and time-domain curves. Antique audio equipment is scattered around, but the data representations are clear and detailed, indicating their focus on audio analysis.</figcaption>
</figure>
</div>
<section id="overview" class="level2">
<h2 class="anchored" data-anchor-id="overview">Overview</h2>
<p>Transportation is the backbone of global commerce. Millions of containers are transported daily by ships, trucks, and trains to destinations worldwide. Ensuring the safe and efficient transit of these containers is a monumental task that requires leveraging modern technology, and TinyML is undoubtedly a key solution.</p>
<p>In this hands-on lab, we will work to solve real-world transportation problems. We will develop a Motion Classification and Anomaly Detection system using the XIAOML Kit, the Arduino IDE, and the Edge Impulse Studio. This project will help us understand how containers experience different forces and motions during various phases of transportation, including terrestrial and maritime transit, vertical movement via forklifts, and periods of stationary storage in warehouses.</p>
<div class="callout callout-style-simple callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Learning Objectives
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Setting up the XIAOML Kit</li>
<li>Data Collection and Preprocessing</li>
<li>Building the Motion Classification Model</li>
<li>Implementing Anomaly Detection</li>
<li>Real-world Testing and Analysis</li>
</ul>
</div>
</div>
<p>By the end of this lab, you’ll have a working prototype that can classify different types of motion and detect anomalies during the transportation of containers. This knowledge can serve as a stepping stone to more advanced projects in the burgeoning field of TinyML, particularly those involving vibration.</p>
</section>
<section id="installing-the-imu" class="level2">
<h2 class="anchored" data-anchor-id="installing-the-imu">Installing the IMU</h2>
<p>The XIAOML Kit comes with a built-in LSM6DS3TR-C 6-axis IMU sensor on the expansion board, eliminating the need for external sensor connections. This integrated approach offers a clean and reliable platform for motion-based machine learning applications.</p>
<p>The LSM6DS3TR-C combines a 3-axis accelerometer and 3-axis gyroscope in a single package, connected via I2C to the XIAO ESP32S3 at address 0x6A that provides:</p>
<ul>
<li><strong>Accelerometer ranges</strong>: ±2/±4/±8/±16 g (we’ll use ±2g by default)</li>
<li><strong>Gyroscope ranges</strong>: ±125/±250/±500/±1000/±2000 dps (we’ll use ±250 dps by default)</li>
<li><strong>Resolution</strong>: 16-bit ADC</li>
<li><strong>Communication</strong>: I2C interface at address 0x6A</li>
<li><strong>Power</strong>: Ultra-low power design</li>
</ul>
<p> <img src="./images/png/imu-directions.png" class="img-fluid" style="width:85.0%" data-fig-align="center"></p>
<p><strong>Coordinate System:</strong> The sensor operates within a right-handed coordinate system. When looking at the expansion board from the bottom (where you can see the IMU sensor with the point mark):</p>
<ul>
<li><strong>X-axis</strong>: Points to the right</li>
<li><strong>Y-axis</strong>: Points forward (away from you)</li>
<li><strong>Z-axis</strong>: Points upward (out of the board)</li>
</ul>
<section id="setting-up-the-hardware" class="level3">
<h3 class="anchored" data-anchor-id="setting-up-the-hardware">Setting Up the Hardware</h3>
<p>Since the XIAOML Kit comes pre-assembled with the expansion board, no additional hardware connections are required. The LSM6DS3TR-C IMU is already properly connected via I2C.</p>
<p><strong>What’s Already Connected:</strong></p>
<ul>
<li>LSM6DS3TR-C IMU → I2C (SDA/SCL) → XIAO ESP32S3</li>
<li>I2C Address: 0x6A</li>
<li>Power: 3.3V from XIAO ESP32S3</li>
</ul>
<p><strong>Required Library:</strong> You should have the library installed during the Setup. If not, install the Seeed Arduino LSM6DS3 library following the steps:</p>
<ol type="1">
<li>Open Arduino IDE Library Manager</li>
<li>Search for “LSM6DS3”</li>
<li>Install <strong>“Seeed Arduino LSM6DS3”</strong> by Seeed Studio</li>
<li><strong>Important</strong>: Do NOT install “Arduino_LSM6DS3 by Arduino” - that’s for different boards!</li>
</ol>
</section>
<section id="testing-the-imu-sensor" class="level3">
<h3 class="anchored" data-anchor-id="testing-the-imu-sensor">Testing the IMU Sensor</h3>
<p>Let’s start with a simple test to verify the IMU is working correctly. Upload this code to test the sensor:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;LSM6DS3.h&gt;</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Wire.h&gt;</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Create IMU object using I2C interface</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>LSM6DS3 myIMU<span class="op">(</span>I2C_MODE<span class="op">,</span> <span class="bn">0x6A</span><span class="op">);</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> accelX<span class="op">,</span> accelY<span class="op">,</span> accelZ<span class="op">;</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> gyroX<span class="op">,</span> gyroY<span class="op">,</span> gyroZ<span class="op">;</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> setup<span class="op">()</span> <span class="op">{</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  Serial<span class="op">.</span>begin<span class="op">(</span><span class="dv">115200</span><span class="op">);</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span> <span class="op">(!</span>Serial<span class="op">)</span> delay<span class="op">(</span><span class="dv">10</span><span class="op">);</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>  Serial<span class="op">.</span>println<span class="op">(</span><span class="st">"XIAOML Kit IMU Test"</span><span class="op">);</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>  Serial<span class="op">.</span>println<span class="op">(</span><span class="st">"LSM6DS3TR-C 6-Axis IMU"</span><span class="op">);</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>  Serial<span class="op">.</span>println<span class="op">(</span><span class="st">"===================="</span><span class="op">);</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Initialize the IMU</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>myIMU<span class="op">.</span>begin<span class="op">()</span> <span class="op">!=</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>      Serial<span class="op">.</span>println<span class="op">(</span><span class="st">"ERROR: IMU initialization failed!"</span><span class="op">);</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>      <span class="cf">while</span><span class="op">(</span><span class="dv">1</span><span class="op">)</span> delay<span class="op">(</span><span class="dv">1000</span><span class="op">);</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>      Serial<span class="op">.</span>println<span class="op">(</span><span class="st">"✓ IMU initialized successfully"</span><span class="op">);</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>      Serial<span class="op">.</span>println<span class="op">(</span><span class="st">"Data Format: AccelX,AccelY,AccelZ,"</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"GyroX,GyroY,GyroZ"</span><span class="op">);</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>      Serial<span class="op">.</span>println<span class="op">(</span><span class="st">"Units: g-force, degrees/second"</span><span class="op">);</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>      Serial<span class="op">.</span>println<span class="op">();</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> loop<span class="op">()</span> <span class="op">{</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Read accelerometer data (in g-force)</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>  accelX <span class="op">=</span> myIMU<span class="op">.</span>readFloatAccelX<span class="op">();</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>  accelY <span class="op">=</span> myIMU<span class="op">.</span>readFloatAccelY<span class="op">();</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>  accelZ <span class="op">=</span> myIMU<span class="op">.</span>readFloatAccelZ<span class="op">();</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Read gyroscope data (in degrees per second)</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>  gyroX <span class="op">=</span> myIMU<span class="op">.</span>readFloatGyroX<span class="op">();</span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>  gyroY <span class="op">=</span> myIMU<span class="op">.</span>readFloatGyroY<span class="op">();</span></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>  gyroZ <span class="op">=</span> myIMU<span class="op">.</span>readFloatGyroZ<span class="op">();</span></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Print readable format</span></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>  Serial<span class="op">.</span>print<span class="op">(</span><span class="st">"Accel (g): X="</span><span class="op">);</span> Serial<span class="op">.</span>print<span class="op">(</span>accelX<span class="op">,</span> <span class="dv">3</span><span class="op">);</span></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>  Serial<span class="op">.</span>print<span class="op">(</span><span class="st">" Y="</span><span class="op">);</span> Serial<span class="op">.</span>print<span class="op">(</span>accelY<span class="op">,</span> <span class="dv">3</span><span class="op">);</span></span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>  Serial<span class="op">.</span>print<span class="op">(</span><span class="st">" Z="</span><span class="op">);</span> Serial<span class="op">.</span>print<span class="op">(</span>accelZ<span class="op">,</span> <span class="dv">3</span><span class="op">);</span></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>  Serial<span class="op">.</span>print<span class="op">(</span><span class="st">" | Gyro (°/s): X="</span><span class="op">);</span> Serial<span class="op">.</span>print<span class="op">(</span>gyroX<span class="op">,</span> <span class="dv">2</span><span class="op">);</span></span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>  Serial<span class="op">.</span>print<span class="op">(</span><span class="st">" Y="</span><span class="op">);</span> Serial<span class="op">.</span>print<span class="op">(</span>gyroY<span class="op">,</span> <span class="dv">2</span><span class="op">);</span></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>  Serial<span class="op">.</span>print<span class="op">(</span><span class="st">" Z="</span><span class="op">);</span> Serial<span class="op">.</span>println<span class="op">(</span>gyroZ<span class="op">,</span> <span class="dv">2</span><span class="op">);</span></span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>  delay<span class="op">(</span><span class="dv">100</span><span class="op">);</span> <span class="co">// 10 Hz update rate</span></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>When the kit is resting flat on a table, you should see:</p>
<ul>
<li>Z-axis acceleration around +1.0g (gravity)</li>
<li>X and Y acceleration near 0.0g</li>
<li>All gyroscope values near 0.0°/s</li>
</ul>
<p>Move the kit around to see the values change accordingly.</p>
</section>
</section>
<section id="the-tinyml-motion-classification-project" class="level2">
<h2 class="anchored" data-anchor-id="the-tinyml-motion-classification-project">The TinyML Motion Classification Project</h2>
<p>We will simulate container (or, more accurately, package) transportation through various scenarios to make this tutorial more relatable and practical.</p>
<p> <img src="./images/jpeg/classes.jpg" class="img-fluid" style="width:85.0%" data-fig-align="center"></p>
<p>Using the accelerometer of the XIAOML Kit, we’ll capture motion data by manually simulating the conditions of:</p>
<ul>
<li><strong>Maritime</strong> (pallets on boats) - Movement in all axes with wave-like patterns</li>
<li><strong>Terrestrial</strong> (pallets on trucks/trains) - Primarily horizontal movement</li>
<li><strong>Lift</strong> (pallets being moved by forklift) - Primarily vertical movement</li>
<li><strong>Idle</strong> (pallets in storage) - Minimal movement</li>
</ul>
<p>From the above image, we can define for our simulation that primarily horizontal movements (<span class="math inline">\(x\)</span> or <span class="math inline">\(y\)</span> axis) should be associated with the “Terrestrial class.” Vertical movements (<span class="math inline">\(z\)</span>-axis) with the “Lift Class,” no activity with the “Idle class,” and movement on all three axes to <a href="https://www.containerhandbuch.de/chb_e/stra/index.html?/chb_e/stra/stra_02_03_03.htm">Maritime class.</a></p>
<p> <img src="./images/jpeg/classes_mov_def.jpg" class="img-fluid" style="width:85.0%" data-fig-align="center"></p>
</section>
<section id="data-collection" class="level2">
<h2 class="anchored" data-anchor-id="data-collection">Data Collection</h2>
<p>For data collection, we have several options available. In a real-world scenario, we can connect our device directly to one container and store the collected data in a file (e.g., CSV) on an SD card. Data can also be sent remotely to a nearby repository, such as a mobile phone, using Wi-Fi or Bluetooth (as demonstrated in this project: <a href="https://www.hackster.io/mjrobot/sensor-datalogger-50e44d">Sensor DataLogger</a>). Once your dataset is collected and stored as a .CSV file, we can upload it to the Studio using the <a href="https://docs.edgeimpulse.com/docs/edge-impulse-studio/data-acquisition/csv-wizard">CSV Wizard tool</a>.</p>
<blockquote class="blockquote">
<p>This <a href="https://youtu.be/2KBPq_826WM">video</a> shows alternative ways to send data to the Edge Impulse Studio.</p>
</blockquote>
<section id="preparing-the-data-collection-code" class="level3">
<h3 class="anchored" data-anchor-id="preparing-the-data-collection-code">Preparing the Data Collection Code</h3>
<p>In this lab, we will connect the Kit directly to the Edge Impulse Studio, which will also be used for data pre-processing, model training, testing, and deployment.</p>
<p>For data collection, we should first connect the Kit to Edge Impulse Studio, which will also be used for data pre-processing, model training, testing, and deployment.</p>
<blockquote class="blockquote">
<p>Follow the instructions <a href="https://docs.edgeimpulse.com/docs/edge-impulse-cli/cli-installation">here</a> to install <a href="https://nodejs.org/en/">Node.js</a> and Edge Impulse CLI on your computer.</p>
</blockquote>
<p>Once the XIAOML Kit is not a fully supported development board by Edge Impulse, we should, for example, use the <a href="https://docs.edgeimpulse.com/docs/edge-impulse-cli/cli-data-forwarder">CLI Data Forwarder</a> to capture data from our sensor and send it to the Studio, as shown in this diagram:</p>
<p> <img src="./images/jpeg/data-forw.jpg" class="img-fluid" style="width:75.0%" data-fig-align="center"></p>
<p>We’ll modify our test code to output data in a format suitable for Edge Impulse:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;LSM6DS3.h&gt;</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Wire.h&gt;</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#define FREQUENCY_HZ        </span><span class="dv">50</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#define INTERVAL_MS         </span><span class="op">(</span><span class="dv">1000</span><span class="pp"> </span><span class="op">/</span><span class="pp"> </span><span class="op">(</span>FREQUENCY_HZ<span class="pp"> </span><span class="op">+</span><span class="pp"> </span><span class="dv">1</span><span class="op">))</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>LSM6DS3 myIMU<span class="op">(</span>I2C_MODE<span class="op">,</span> <span class="bn">0x6A</span><span class="op">);</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="at">static</span> <span class="dt">unsigned</span> <span class="dt">long</span> last_interval_ms <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> setup<span class="op">()</span> <span class="op">{</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  Serial<span class="op">.</span>begin<span class="op">(</span><span class="dv">115200</span><span class="op">);</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span> <span class="op">(!</span>Serial<span class="op">)</span> delay<span class="op">(</span><span class="dv">10</span><span class="op">);</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>  Serial<span class="op">.</span>println<span class="op">(</span><span class="st">"XIAOML Kit - Motion Data Collection"</span><span class="op">);</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>  Serial<span class="op">.</span>println<span class="op">(</span><span class="st">"LSM6DS3TR-C IMU Sensor"</span><span class="op">);</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Initialize IMU</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>myIMU<span class="op">.</span>begin<span class="op">()</span> <span class="op">!=</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>      Serial<span class="op">.</span>println<span class="op">(</span><span class="st">"ERROR: IMU initialization failed!"</span><span class="op">);</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>      <span class="cf">while</span><span class="op">(</span><span class="dv">1</span><span class="op">)</span> delay<span class="op">(</span><span class="dv">1000</span><span class="op">);</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>  delay<span class="op">(</span><span class="dv">2000</span><span class="op">);</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>  Serial<span class="op">.</span>println<span class="op">(</span><span class="st">"Starting data collection in 3 seconds..."</span><span class="op">);</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>  delay<span class="op">(</span><span class="dv">3000</span><span class="op">);</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> loop<span class="op">()</span> <span class="op">{</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>millis<span class="op">()</span> <span class="op">&gt;</span> last_interval_ms <span class="op">+</span> INTERVAL_MS<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>      last_interval_ms <span class="op">=</span> millis<span class="op">();</span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Read accelerometer data</span></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>      <span class="dt">float</span> ax <span class="op">=</span> myIMU<span class="op">.</span>readFloatAccelX<span class="op">();</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>      <span class="dt">float</span> ay <span class="op">=</span> myIMU<span class="op">.</span>readFloatAccelY<span class="op">();</span></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>      <span class="dt">float</span> az <span class="op">=</span> myIMU<span class="op">.</span>readFloatAccelZ<span class="op">();</span></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Convert to m/s² (multiply by 9.81)</span></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>      <span class="dt">float</span> ax_ms2 <span class="op">=</span> ax <span class="op">*</span> <span class="fl">9.81</span><span class="op">;</span></span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>      <span class="dt">float</span> ay_ms2 <span class="op">=</span> ay <span class="op">*</span> <span class="fl">9.81</span><span class="op">;</span></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>      <span class="dt">float</span> az_ms2 <span class="op">=</span> az <span class="op">*</span> <span class="fl">9.81</span><span class="op">;</span></span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Output in Edge Impulse format</span></span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>      Serial<span class="op">.</span>print<span class="op">(</span>ax_ms2<span class="op">);</span></span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>      Serial<span class="op">.</span>print<span class="op">(</span><span class="st">"</span><span class="sc">\t</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>      Serial<span class="op">.</span>print<span class="op">(</span>ay_ms2<span class="op">);</span></span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>      Serial<span class="op">.</span>print<span class="op">(</span><span class="st">"</span><span class="sc">\t</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>      Serial<span class="op">.</span>println<span class="op">(</span>az_ms2<span class="op">);</span></span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Upload the code to the Arduino IDE. We should see the accelerometer values (converted to m/s²) at the Serial Monitor:</p>
<p> <img src="./images/png/serial_monitor.png" class="img-fluid" style="width:85.0%" data-fig-align="center"></p>
<blockquote class="blockquote">
<p>Keep the code running, but <strong>turn off the Serial Monitor</strong>. The data generated by the Kit will be sent to the Edge Impulse Studio via Serial Connection.</p>
</blockquote>
</section>
<section id="connecting-to-edge-impulse-for-data-collection" class="level3">
<h3 class="anchored" data-anchor-id="connecting-to-edge-impulse-for-data-collection">Connecting to Edge Impulse for Data Collection</h3>
<p><strong>Create an Edge Impulse Project</strong> - Go to Edge Impulse Studio and create a new project - Choose a descriptive name (keep under 63 characters for Arduino library compatibility)</p>
<p> <img src="./images/png/eistudio-ini.png" class="img-fluid" style="width:85.0%" data-fig-align="center"></p>
<p><strong>Set up CLI Data Forwarder</strong> - Install Edge Impulse CLI on your computer - Confirm that the XIAOML Kit is connected to the computer, <strong>the code is running and the Serial Monitor is OFF</strong>, otherwise we can get an error. - On the Computer Terminal, run: <code>edge-impulse-data-forwarder --clean</code> - Enter your Edge Impulse credentials - Select your project and configure device settings</p>
<p> <img src="./images/png/terminal-cli.png" class="img-fluid" style="width:85.0%" data-fig-align="center"></p>
<ul>
<li>Go to the Edge Impulse Studio Project. On the <code>Device</code> section is possible to verify if the kit is correctly connected (the dot should be green).</li>
</ul>
<p> <img src="./images/png/ei-device.png" class="img-fluid" style="width:85.0%" data-fig-align="center"></p>
</section>
</section>
<section id="data-collection-at-the-studio" class="level2">
<h2 class="anchored" data-anchor-id="data-collection-at-the-studio">Data Collection at the Studio</h2>
<p>As discussed before, we should capture data from all four <strong>Transportation Classes.</strong> Imagine that you have a container with a built-in accelerometer (In this case, our XIAOML Kit). Now imagine your container is on a boat, facing an angry ocean:</p>
<p> <img src="./images/png/boat.png" class="img-fluid" style="width:70.0%" data-fig-align="center"></p>
<p>Or in a Truck, travelling on a road, or being moved with a forklift, etc.</p>
<section id="movement-simulation" class="level3">
<h3 class="anchored" data-anchor-id="movement-simulation">Movement Simulation</h3>
<p><strong>Maritime Class:</strong></p>
<ul>
<li>Hold the kit and simulate boat movement</li>
<li>Move in all three axes with wave-like, undulating motions</li>
<li>Include gentle rolling and pitching movements</li>
</ul>
<p><strong>Terrestrial Class:</strong></p>
<ul>
<li>Move the kit horizontally in straight lines (left to right and vice versa)</li>
<li>Simulate truck/train vibrations with small horizontal shakes</li>
<li>Occasional gentle bumps and turns</li>
</ul>
<p><strong>Lift Class:</strong></p>
<ul>
<li>Move the kit primarily in vertical directions (up and down)</li>
<li>Simulate forklift operations: up, pause, down</li>
<li>Include some short horizontal positioning movements</li>
</ul>
<p><strong>Idle Class:</strong></p>
<ul>
<li>Place the kit on a stable surface</li>
<li>Minimal to no movement</li>
<li>Capture environmental vibrations and sensor noise</li>
</ul>
</section>
<section id="data-acquisition" class="level3">
<h3 class="anchored" data-anchor-id="data-acquisition">Data Acquisition</h3>
<p>On the <code>Data Acquisition</code> section, you should see that your board <code>[xiaoml-kit]</code> is connected. The sensor is available: <code>[sensor with 3 axes (accX, accY, accZ)]</code> with a sampling frequency of <code>[50 Hz]</code>. The Studio suggests a sample length of <code>[10000]</code> ms (10 s). The last thing left is defining the sample label. Let’s start, for example, with<code>[terrestrial]</code>.</p>
<p>Press <code>[Start Sample]</code>and move your kit horizontally (left to right), keeping it in one direction. After 10 seconds, our data will be uploaded to the Studio.</p>
<p>Below is one sample (raw data) of 10 seconds of collected data. It is notable that the ondulatory movement predominantly occurs along the Y-axis (left-right). The other axes are almost stationary (the X-axis is centered around zero, and the Z-axis is centered around 9.8 ms² due to gravity).</p>
<p> <img src="./images/png/terrestrial-raw_data.png" class="img-fluid" style="width:70.0%" data-fig-align="center"></p>
<p>You should capture, for example, around 2 minutes (ten to twelve samples of 10 seconds each) for each of the four classes. Using the <code>3 dots</code> after each sample, select two and move them to the <strong>Test set</strong>. Alternatively, you can use the Automatic <code>Train/Test Split</code> tool on the <strong>Danger Zone</strong> of the <code>Dashboard</code> tab. Below, it is possible to see the result datasets:</p>
<p> <img src="./images/png/datasets.png" class="img-fluid" style="width:85.0%" data-fig-align="center"></p>
</section>
</section>
<section id="data-pre-processing" class="level2">
<h2 class="anchored" data-anchor-id="data-pre-processing">Data Pre-Processing</h2>
<p>The raw data type captured by the accelerometer is a “time series” and should be converted to “tabular data”. We can do this conversion using a sliding window over the sample data. For example, in the below figure,</p>
<p> <img src="./images/png/features.png" class="img-fluid" style="width:85.0%" data-fig-align="center"></p>
<p>We can see 10 seconds of accelerometer data captured with a sample rate (SR) of 50 Hz. A 2-second window will capture 300 data points (3 axes <span class="math inline">\(\times\)</span> 2 seconds <span class="math inline">\(\times\)</span> 50 samples). We will slide this window every 200ms, creating a larger dataset where each instance has 300 raw features.</p>
<blockquote class="blockquote">
<p>You should use the best SR for your case, given Nyquist’s theorem, which states that a periodic signal must be sampled at least twice the highest frequency component.</p>
</blockquote>
<p>Data preprocessing is a challenging area for embedded machine learning. Still, Edge Impulse helps overcome this with its digital signal processing (DSP) preprocessing step and, more specifically, the Spectral Features.</p>
<p>In the Studio, this dataset will be the input to a Spectral Analysis block, which is well-suited to analyzing repetitive motion, such as accelerometer data. This block will perform a DSP (Digital Signal Processing), extracting features such as “FFT” or “Wavelets”. In the most common case, FFT, the <strong>Time Domain Statistical features</strong> per axis/channel are:</p>
<ul>
<li>RMS</li>
<li>Skewness</li>
<li>Kurtosis</li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/png/time-dom.png" class="img-fluid figure-img" style="width:85.0%"></p>
</figure>
</div>
<p>And the <strong>Frequency Domain Spectral features</strong> per axis/channel are:</p>
<ul>
<li>Spectral Power</li>
<li>Skewness</li>
<li>Kurtosis</li>
</ul>
<p> <img src="./images/png/freq-dom.png" class="img-fluid" style="width:85.0%" data-fig-align="center"></p>
<p>For example, for an FFT length of 32 points, the Spectral Analysis Block’s resulting output will be 21 features per axis (a total of 63 features).</p>
<p>Those 63 features will serve as the input tensor for a Neural Network Classifier and the Anomaly Detection model (K-Means).</p>
<blockquote class="blockquote">
<p>You can learn more by digging into the lab <a href="../../../content/shared/dsp_spectral_features_block/dsp_spectral_features_block.html">DSP Spectral Features</a></p>
</blockquote>
</section>
<section id="model-design" class="level2">
<h2 class="anchored" data-anchor-id="model-design">Model Design</h2>
<p>Our classifier will be a Dense Neural Network (DNN) that will have 63 neurons on its input layer, two hidden layers with 20 and 10 neurons, and an output layer with four neurons (one per each class), as shown here:</p>
<p> <img src="./images/png/model.png" class="img-fluid" style="width:85.0%" data-fig-align="center"></p>
</section>
<section id="impulse-design" class="level2">
<h2 class="anchored" data-anchor-id="impulse-design">Impulse Design</h2>
<p>An impulse takes raw data, uses signal processing to extract features, and then uses a learning block (<strong>Dense model</strong>) to classify new data.</p>
<p>We also utilize a second model, the <strong>K-means</strong>, which can be used for Anomaly Detection. If we imagine that we could have our known classes as clusters, any sample that cannot fit into one of these clusters could be an outlier, an anomaly (for example, a container rolling out of a ship on the ocean or being upside down on the floor).</p>
<p> <img src="./images/jpeg/anomaly.jpg" class="img-fluid" style="width:70.0%" data-fig-align="center"></p>
<blockquote class="blockquote">
<p>Imagine our XIAOML Kit rolling or moving upside-down, on a movement complement different from the one trained on.</p>
</blockquote>
<p> <img src="./images/png/models.png" class="img-fluid" style="width:85.0%" data-fig-align="center"></p>
<p>Below the final Impulse design:</p>
<p> <img src="./images/png/impulse.png" class="img-fluid" style="width:85.0%" data-fig-align="center"></p>
</section>
<section id="generating-features" class="level2">
<h2 class="anchored" data-anchor-id="generating-features">Generating features</h2>
<p>At this point in our project, we have defined the preprocessing method and designed the model. Now, it is time to have the job done. First, let’s convert the raw data (time-series type) into tabular data. Go to the <code>Spectral Features</code> tab and select <code>[Save Parameters]</code>. Alternatively, instead of using the default values, we can select the <code>[Autotune parameters]</code> button. In this case, the Studio will define new hyperparameters, such as the filter design and FFT length, based on the raw data.</p>
<p> <img src="./images/png/features-2.png" class="img-fluid" style="width:85.0%" data-fig-align="center"></p>
<p>At the top menu, select the <code>Generate features</code> tab, and there, select the options, <code>Calculate feature importance</code>, <code>Normalize features,</code> and press the <code>[Generate features]</code> button. Each 2-second window of data (300 data points) will be converted into a single tabular data point with 63 features.</p>
<blockquote class="blockquote">
<p>The Feature Explorer will display this data in 2D using <a href="https://umap-learn.readthedocs.io/en/latest/">UMAP.</a> Uniform Manifold Approximation and Projection (UMAP) is a dimensionality-reduction technique used for visualization, similar to t-SNE, but also for general nonlinear dimensionality reduction.</p>
</blockquote>
<p>The visualization shows that the classes are well separated, indicating that the classifier should perform well.</p>
<p> <img src="./images/png/feat-ger.png" class="img-fluid" style="width:85.0%" data-fig-align="center"></p>
<p>Optionally, you can analyze the relative importance of each feature for one class compared with other classes.</p>
</section>
<section id="training" class="level2">
<h2 class="anchored" data-anchor-id="training">Training</h2>
<p>Our classifier will be a Dense Neural Network (DNN) that will have 63 neurons on its input layer, two hidden layers with 20 and 10 neurons, and an output layer with four neurons (one per each class), as shown here:</p>
<p> <img src="./images/png/model-2.png" class="img-fluid" style="width:85.0%" data-fig-align="center"></p>
<p>As hyperparameters, we will use a Learning Rate of 0.005 and 20% of the data for validation for 30 epochs. After training, we can see that the accuracy is 100%.</p>
<p> <img src="./images/png/train.png" class="img-fluid" style="width:85.0%" data-fig-align="center"></p>
<p>For anomaly detection, we should select the suggested features that are most important for feature extraction. The number of clusters will be 32, as suggested by the Studio. After training, we can select some data for testing, such as maritime data. The resulting Anomally score was <code>min: -0.1642, max: 0.0738, avg: -0.0867</code>.</p>
<p>When changing the data, it is possible to realize that small or negative Anomaly Scores indicate that the data are normal.</p>
<p> <img src="./images/png/anomaly-train.png" class="img-fluid" style="width:70.0%" data-fig-align="center"></p>
</section>
<section id="testing" class="level2">
<h2 class="anchored" data-anchor-id="testing">Testing</h2>
<p>Using 20% of the data left behind during the data capture phase, we can verify how our model will behave with unknown data; if not 100% (what is expected), the result was very good (8%).</p>
<p> <img src="./images/png/test.png" class="img-fluid" style="width:85.0%" data-fig-align="center"></p>
<p>You should also use your kit (which is still connected to the Studio) and perform some Live Classification. For example, let’s test some “terrestrial” movement:</p>
<p> <img src="./images/png/live-test.png" class="img-fluid" style="width:85.0%" data-fig-align="center"></p>
<blockquote class="blockquote">
<p>Be aware that here, you will capture real data with your device and upload it to the Studio, where an inference will be made using the trained model (note that the model is not on your device).</p>
</blockquote>
</section>
<section id="deploy" class="level2">
<h2 class="anchored" data-anchor-id="deploy">Deploy</h2>
<p>Now it is time for magic! The Studio will package all the needed libraries, preprocessing functions, and trained models, downloading them to your computer. You should select the Arduino Library option, and then, at the bottom, choose Quantized (Int8) and click <code>[Build]</code>. A ZIP file will be created and downloaded to your computer.</p>
<p> <img src="./images/png/deploy.png" class="img-fluid" style="width:85.0%" data-fig-align="center"></p>
<p>On your Arduino IDE, go to the Sketch tab, select the option Add.ZIP Library, and Choose the.zip file downloaded by the Studio:</p>
<p> <img src="./images/png/lib.png" class="img-fluid" style="width:85.0%" data-fig-align="center"></p>
</section>
<section id="inference" class="level2">
<h2 class="anchored" data-anchor-id="inference">Inference</h2>
<p>Now, it is time for a real test. We will make inferences that are wholly disconnected from the Studio. Let’s change one of the code examples created when you deploy the Arduino Library.</p>
<p>In your Arduino IDE, go to the <code>File/Examples</code> tab and look for your project, and in examples, select <code>nano_ble_sense_accelerometer</code>:</p>
<p>Of course, this is not your board, but we can have the code working with only a few changes.</p>
<p>For example, at the beginning of the code, you have the library related to Arduino Sense IMU:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* Includes -------------------------------------------- */</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;XIAOML_Kit_Motion_Class_-_AD_inferencing.h&gt;</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Arduino_LSM9DS1.h&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Change the “includes” portion with the code related to the IMU:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;XIAOML_Kit_Motion_Class_-_AD_inferencing.h&gt;</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;LSM6DS3.h&gt;</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Wire.h&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Change the Constant Defines</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">// IMU setup</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>LSM6DS3 myIMU<span class="op">(</span>I2C_MODE<span class="op">,</span> <span class="bn">0x6A</span><span class="op">);</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Inference settings</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#define CONVERT_G_TO_MS2    </span><span class="fl">9.81</span><span class="bu">f</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="pp">#define MAX_ACCEPTED_RANGE  </span><span class="fl">2.0</span><span class="bu">f</span><span class="pp"> </span><span class="op">*</span><span class="pp"> </span>CONVERT_G_TO_MS2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>On the setup function, initiate the IMU:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>   <span class="co">// Initialize IMU</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>myIMU<span class="op">.</span>begin<span class="op">()</span> <span class="op">!=</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>        Serial<span class="op">.</span>println<span class="op">(</span><span class="st">"ERROR: IMU initialization failed!"</span><span class="op">);</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span><span class="op">;</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>At the loop function, the buffers buffer[ix], buffer[ix + 1], and buffer[ix + 2] will receive the 3-axis data captured by the accelerometer. In the original code, you have the line:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>IMU<span class="op">.</span>readAcceleration<span class="op">(</span>buffer<span class="op">[</span>ix<span class="op">],</span> buffer<span class="op">[</span>ix <span class="op">+</span> <span class="dv">1</span><span class="op">],</span> buffer<span class="op">[</span>ix <span class="op">+</span> <span class="dv">2</span><span class="op">]);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Change it with this block of code:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Read IMU data</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> x <span class="op">=</span> myIMU<span class="op">.</span>readFloatAccelX<span class="op">();</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> y <span class="op">=</span> myIMU<span class="op">.</span>readFloatAccelY<span class="op">();</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> z <span class="op">=</span> myIMU<span class="op">.</span>readFloatAccelZ<span class="op">();</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>You should reorder the following two blocks of code. First, you make the conversion to raw data to “Meters per squared second (m/s<sup>2</sup>)”, followed by the test regarding the maximum acceptance range (that here is in m/s<sup>2</sup>, but on Arduino, was in Gs):</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Convert to m/s²</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  buffer<span class="op">[</span>i <span class="op">+</span> <span class="dv">0</span><span class="op">]</span> <span class="op">=</span> x <span class="op">*</span> CONVERT_G_TO_MS2<span class="op">;</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  buffer<span class="op">[</span>i <span class="op">+</span> <span class="dv">1</span><span class="op">]</span> <span class="op">=</span> y <span class="op">*</span> CONVERT_G_TO_MS2<span class="op">;</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  buffer<span class="op">[</span>i <span class="op">+</span> <span class="dv">2</span><span class="op">]</span> <span class="op">=</span> z <span class="op">*</span> CONVERT_G_TO_MS2<span class="op">;</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Apply range limiting</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> <span class="dv">3</span><span class="op">;</span> j<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>fabs<span class="op">(</span>buffer<span class="op">[</span>i <span class="op">+</span> j<span class="op">])</span> <span class="op">&gt;</span> MAX_ACCEPTED_RANGE<span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>          buffer<span class="op">[</span>i <span class="op">+</span> j<span class="op">]</span> <span class="op">=</span> copysign<span class="op">(</span>MAX_ACCEPTED_RANGE<span class="op">,</span> buffer<span class="op">[</span>i <span class="op">+</span> j<span class="op">]);</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>And this is enough. We can also adjust how the inference is displayed in the Serial Monitor. You can now upload the complete code below to your device and proceed with the inferences.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Motion Classification with LSM6DS3TR-C IMU</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;XIAOML_Kit_Motion_Class_-_AD_inferencing.h&gt;</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;LSM6DS3.h&gt;</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Wire.h&gt;</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="co">// IMU setup</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>LSM6DS3 myIMU<span class="op">(</span>I2C_MODE<span class="op">,</span> <span class="bn">0x6A</span><span class="op">);</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="co">// Inference settings</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="pp">#define CONVERT_G_TO_MS2    </span><span class="fl">9.81</span><span class="bu">f</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="pp">#define MAX_ACCEPTED_RANGE  </span><span class="fl">2.0</span><span class="bu">f</span><span class="pp"> </span><span class="op">*</span><span class="pp"> </span>CONVERT_G_TO_MS2</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="at">static</span> <span class="dt">bool</span> debug_nn <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a><span class="at">static</span> <span class="dt">float</span> buffer<span class="op">[</span>EI_CLASSIFIER_DSP_INPUT_FRAME_SIZE<span class="op">]</span> <span class="op">=</span> <span class="op">{</span> <span class="dv">0</span> <span class="op">};</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a><span class="at">static</span> <span class="dt">float</span> inference_buffer<span class="op">[</span>EI_CLASSIFIER_DSP_INPUT_FRAME_SIZE<span class="op">];</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> setup<span class="op">()</span> <span class="op">{</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>    Serial<span class="op">.</span>begin<span class="op">(</span><span class="dv">115200</span><span class="op">);</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(!</span>Serial<span class="op">)</span> delay<span class="op">(</span><span class="dv">10</span><span class="op">);</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>    Serial<span class="op">.</span>println<span class="op">(</span><span class="st">"XIAOML Kit - Motion Classification"</span><span class="op">);</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>    Serial<span class="op">.</span>println<span class="op">(</span><span class="st">"LSM6DS3TR-C IMU Inference"</span><span class="op">);</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Initialize IMU</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>myIMU<span class="op">.</span>begin<span class="op">()</span> <span class="op">!=</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>        Serial<span class="op">.</span>println<span class="op">(</span><span class="st">"ERROR: IMU initialization failed!"</span><span class="op">);</span></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span><span class="op">;</span></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>    Serial<span class="op">.</span>println<span class="op">(</span><span class="st">"✓ IMU initialized"</span><span class="op">);</span></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>EI_CLASSIFIER_RAW_SAMPLES_PER_FRAME <span class="op">!=</span> <span class="dv">3</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>        Serial<span class="op">.</span>println<span class="op">(</span><span class="st">"ERROR: EI_CLASSIFIER_RAW_SAMPLES_PER_FRAME"</span></span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>                       <span class="st">"should be 3"</span><span class="op">);</span></span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span><span class="op">;</span></span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>    Serial<span class="op">.</span>println<span class="op">(</span><span class="st">"✓ Model loaded"</span><span class="op">);</span></span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>    Serial<span class="op">.</span>println<span class="op">(</span><span class="st">"Starting motion classification..."</span><span class="op">);</span></span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> loop<span class="op">()</span> <span class="op">{</span></span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>    ei_printf<span class="op">(</span><span class="st">"</span><span class="sc">\n</span><span class="st">Starting inferencing in 2 seconds...</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>    delay<span class="op">(</span><span class="dv">2000</span><span class="op">);</span></span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>    ei_printf<span class="op">(</span><span class="st">"Sampling...</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Clear buffer</span></span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> EI_CLASSIFIER_DSP_INPUT_FRAME_SIZE<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a>        buffer<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> <span class="fl">0.0</span><span class="bu">f</span><span class="op">;</span></span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Collect accelerometer data</span></span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> EI_CLASSIFIER_DSP_INPUT_FRAME_SIZE<span class="op">;</span> i <span class="op">+=</span> <span class="dv">3</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uint64_t</span> next_tick <span class="op">=</span> micros<span class="op">()</span> <span class="op">+</span></span>
<span id="cb10-56"><a href="#cb10-56" aria-hidden="true" tabindex="-1"></a>          <span class="op">(</span>EI_CLASSIFIER_INTERVAL_MS <span class="op">*</span> <span class="dv">1000</span><span class="op">);</span></span>
<span id="cb10-57"><a href="#cb10-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-58"><a href="#cb10-58" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Read IMU data</span></span>
<span id="cb10-59"><a href="#cb10-59" aria-hidden="true" tabindex="-1"></a>        <span class="dt">float</span> x <span class="op">=</span> myIMU<span class="op">.</span>readFloatAccelX<span class="op">();</span></span>
<span id="cb10-60"><a href="#cb10-60" aria-hidden="true" tabindex="-1"></a>        <span class="dt">float</span> y <span class="op">=</span> myIMU<span class="op">.</span>readFloatAccelY<span class="op">();</span></span>
<span id="cb10-61"><a href="#cb10-61" aria-hidden="true" tabindex="-1"></a>        <span class="dt">float</span> z <span class="op">=</span> myIMU<span class="op">.</span>readFloatAccelZ<span class="op">();</span></span>
<span id="cb10-62"><a href="#cb10-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-63"><a href="#cb10-63" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Convert to m/s²</span></span>
<span id="cb10-64"><a href="#cb10-64" aria-hidden="true" tabindex="-1"></a>        buffer<span class="op">[</span>i <span class="op">+</span> <span class="dv">0</span><span class="op">]</span> <span class="op">=</span> x <span class="op">*</span> CONVERT_G_TO_MS2<span class="op">;</span></span>
<span id="cb10-65"><a href="#cb10-65" aria-hidden="true" tabindex="-1"></a>        buffer<span class="op">[</span>i <span class="op">+</span> <span class="dv">1</span><span class="op">]</span> <span class="op">=</span> y <span class="op">*</span> CONVERT_G_TO_MS2<span class="op">;</span></span>
<span id="cb10-66"><a href="#cb10-66" aria-hidden="true" tabindex="-1"></a>        buffer<span class="op">[</span>i <span class="op">+</span> <span class="dv">2</span><span class="op">]</span> <span class="op">=</span> z <span class="op">*</span> CONVERT_G_TO_MS2<span class="op">;</span></span>
<span id="cb10-67"><a href="#cb10-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-68"><a href="#cb10-68" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Apply range limiting</span></span>
<span id="cb10-69"><a href="#cb10-69" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> <span class="dv">3</span><span class="op">;</span> j<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb10-70"><a href="#cb10-70" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>fabs<span class="op">(</span>buffer<span class="op">[</span>i <span class="op">+</span> j<span class="op">])</span> <span class="op">&gt;</span> MAX_ACCEPTED_RANGE<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-71"><a href="#cb10-71" aria-hidden="true" tabindex="-1"></a>                buffer<span class="op">[</span>i <span class="op">+</span> j<span class="op">]</span> <span class="op">=</span> copysign<span class="op">(</span>MAX_ACCEPTED_RANGE<span class="op">,</span></span>
<span id="cb10-72"><a href="#cb10-72" aria-hidden="true" tabindex="-1"></a>                                         buffer<span class="op">[</span>i <span class="op">+</span> j<span class="op">]);</span></span>
<span id="cb10-73"><a href="#cb10-73" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb10-74"><a href="#cb10-74" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb10-75"><a href="#cb10-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-76"><a href="#cb10-76" aria-hidden="true" tabindex="-1"></a>        delayMicroseconds<span class="op">(</span>next_tick <span class="op">-</span> micros<span class="op">());</span></span>
<span id="cb10-77"><a href="#cb10-77" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb10-78"><a href="#cb10-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-79"><a href="#cb10-79" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Copy to inference buffer</span></span>
<span id="cb10-80"><a href="#cb10-80" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> EI_CLASSIFIER_DSP_INPUT_FRAME_SIZE<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb10-81"><a href="#cb10-81" aria-hidden="true" tabindex="-1"></a>        inference_buffer<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> buffer<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb10-82"><a href="#cb10-82" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb10-83"><a href="#cb10-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-84"><a href="#cb10-84" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Create signal from buffer</span></span>
<span id="cb10-85"><a href="#cb10-85" aria-hidden="true" tabindex="-1"></a>    <span class="dt">signal_t</span> signal<span class="op">;</span></span>
<span id="cb10-86"><a href="#cb10-86" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> err <span class="op">=</span> numpy<span class="op">::</span>signal_from_buffer<span class="op">(</span>inference_buffer<span class="op">,</span></span>
<span id="cb10-87"><a href="#cb10-87" aria-hidden="true" tabindex="-1"></a>              EI_CLASSIFIER_DSP_INPUT_FRAME_SIZE<span class="op">,</span> <span class="op">&amp;</span>signal<span class="op">);</span></span>
<span id="cb10-88"><a href="#cb10-88" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>err <span class="op">!=</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-89"><a href="#cb10-89" aria-hidden="true" tabindex="-1"></a>        ei_printf<span class="op">(</span><span class="st">"ERROR: Failed to create signal from buffer (</span><span class="sc">%d</span><span class="st">)</span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span></span>
<span id="cb10-90"><a href="#cb10-90" aria-hidden="true" tabindex="-1"></a>                  err<span class="op">);</span></span>
<span id="cb10-91"><a href="#cb10-91" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span><span class="op">;</span></span>
<span id="cb10-92"><a href="#cb10-92" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb10-93"><a href="#cb10-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-94"><a href="#cb10-94" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Run the classifier</span></span>
<span id="cb10-95"><a href="#cb10-95" aria-hidden="true" tabindex="-1"></a>    <span class="dt">ei_impulse_result_t</span> result <span class="op">=</span> <span class="op">{</span> <span class="dv">0</span> <span class="op">};</span></span>
<span id="cb10-96"><a href="#cb10-96" aria-hidden="true" tabindex="-1"></a>    err <span class="op">=</span> run_classifier<span class="op">(&amp;</span>signal<span class="op">,</span> <span class="op">&amp;</span>result<span class="op">,</span> debug_nn<span class="op">);</span></span>
<span id="cb10-97"><a href="#cb10-97" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>err <span class="op">!=</span> EI_IMPULSE_OK<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-98"><a href="#cb10-98" aria-hidden="true" tabindex="-1"></a>        ei_printf<span class="op">(</span><span class="st">"ERROR: Failed to run classifier (</span><span class="sc">%d</span><span class="st">)</span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span> err<span class="op">);</span></span>
<span id="cb10-99"><a href="#cb10-99" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span><span class="op">;</span></span>
<span id="cb10-100"><a href="#cb10-100" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb10-101"><a href="#cb10-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-102"><a href="#cb10-102" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Print predictions</span></span>
<span id="cb10-103"><a href="#cb10-103" aria-hidden="true" tabindex="-1"></a>    ei_printf<span class="op">(</span><span class="st">"Predictions (DSP: </span><span class="sc">%d</span><span class="st"> ms, Classification: </span><span class="sc">%d</span><span class="st"> ms, "</span></span>
<span id="cb10-104"><a href="#cb10-104" aria-hidden="true" tabindex="-1"></a>              <span class="st">"Anomaly: </span><span class="sc">%d</span><span class="st"> ms):</span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span></span>
<span id="cb10-105"><a href="#cb10-105" aria-hidden="true" tabindex="-1"></a>        result<span class="op">.</span>timing<span class="op">.</span>dsp<span class="op">,</span> result<span class="op">.</span>timing<span class="op">.</span>classification<span class="op">,</span> result<span class="op">.</span>timing<span class="op">.</span>anomaly<span class="op">);</span></span>
<span id="cb10-106"><a href="#cb10-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-107"><a href="#cb10-107" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> ix <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> ix <span class="op">&lt;</span> EI_CLASSIFIER_LABEL_COUNT<span class="op">;</span> ix<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb10-108"><a href="#cb10-108" aria-hidden="true" tabindex="-1"></a>        ei_printf<span class="op">(</span><span class="st">"    </span><span class="sc">%s</span><span class="st">: </span><span class="sc">%.5f\n</span><span class="st">"</span><span class="op">,</span> result<span class="op">.</span>classification<span class="op">[</span>ix<span class="op">].</span>label<span class="op">,</span></span>
<span id="cb10-109"><a href="#cb10-109" aria-hidden="true" tabindex="-1"></a>                  result<span class="op">.</span>classification<span class="op">[</span>ix<span class="op">].</span>value<span class="op">);</span></span>
<span id="cb10-110"><a href="#cb10-110" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb10-111"><a href="#cb10-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-112"><a href="#cb10-112" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Print anomaly score</span></span>
<span id="cb10-113"><a href="#cb10-113" aria-hidden="true" tabindex="-1"></a><span class="pp">#if EI_CLASSIFIER_HAS_ANOMALY == 1</span></span>
<span id="cb10-114"><a href="#cb10-114" aria-hidden="true" tabindex="-1"></a>    ei_printf<span class="op">(</span><span class="st">"Anomaly score: </span><span class="sc">%.3f\n</span><span class="st">"</span><span class="op">,</span> result<span class="op">.</span>anomaly<span class="op">);</span></span>
<span id="cb10-115"><a href="#cb10-115" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb10-116"><a href="#cb10-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-117"><a href="#cb10-117" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Determine prediction</span></span>
<span id="cb10-118"><a href="#cb10-118" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> max_confidence <span class="op">=</span> <span class="fl">0.0</span><span class="op">;</span></span>
<span id="cb10-119"><a href="#cb10-119" aria-hidden="true" tabindex="-1"></a>    String predicted_class <span class="op">=</span> <span class="st">"unknown"</span><span class="op">;</span></span>
<span id="cb10-120"><a href="#cb10-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-121"><a href="#cb10-121" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> ix <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> ix <span class="op">&lt;</span> EI_CLASSIFIER_LABEL_COUNT<span class="op">;</span> ix<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb10-122"><a href="#cb10-122" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>result<span class="op">.</span>classification<span class="op">[</span>ix<span class="op">].</span>value <span class="op">&gt;</span> max_confidence<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-123"><a href="#cb10-123" aria-hidden="true" tabindex="-1"></a>            max_confidence <span class="op">=</span> result<span class="op">.</span>classification<span class="op">[</span>ix<span class="op">].</span>value<span class="op">;</span></span>
<span id="cb10-124"><a href="#cb10-124" aria-hidden="true" tabindex="-1"></a>            predicted_class <span class="op">=</span> String<span class="op">(</span>result<span class="op">.</span>classification<span class="op">[</span>ix<span class="op">].</span>label<span class="op">);</span></span>
<span id="cb10-125"><a href="#cb10-125" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb10-126"><a href="#cb10-126" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb10-127"><a href="#cb10-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-128"><a href="#cb10-128" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Display result with confidence threshold</span></span>
<span id="cb10-129"><a href="#cb10-129" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>max_confidence <span class="op">&gt;</span> <span class="fl">0.6</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-130"><a href="#cb10-130" aria-hidden="true" tabindex="-1"></a>        ei_printf<span class="op">(</span><span class="st">"</span><span class="sc">\n</span><span class="st">🎯 PREDICTION: </span><span class="sc">%s</span><span class="st"> (</span><span class="sc">%.1f%%</span><span class="st"> confidence)</span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span></span>
<span id="cb10-131"><a href="#cb10-131" aria-hidden="true" tabindex="-1"></a>                 predicted_class<span class="op">.</span>c_str<span class="op">(),</span> max_confidence <span class="op">*</span> <span class="dv">100</span><span class="op">);</span></span>
<span id="cb10-132"><a href="#cb10-132" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb10-133"><a href="#cb10-133" aria-hidden="true" tabindex="-1"></a>        ei_printf<span class="op">(</span><span class="st">"</span><span class="sc">\n</span><span class="st">❓ UNCERTAIN: Highest confidence is </span><span class="sc">%s</span><span class="st"> (</span><span class="sc">%.1f%%</span><span class="st">)</span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span></span>
<span id="cb10-134"><a href="#cb10-134" aria-hidden="true" tabindex="-1"></a>                 predicted_class<span class="op">.</span>c_str<span class="op">(),</span> max_confidence <span class="op">*</span> <span class="dv">100</span><span class="op">);</span></span>
<span id="cb10-135"><a href="#cb10-135" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb10-136"><a href="#cb10-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-137"><a href="#cb10-137" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check for anomaly</span></span>
<span id="cb10-138"><a href="#cb10-138" aria-hidden="true" tabindex="-1"></a><span class="pp">#if EI_CLASSIFIER_HAS_ANOMALY == 1</span></span>
<span id="cb10-139"><a href="#cb10-139" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>result<span class="op">.</span>anomaly <span class="op">&gt;</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-140"><a href="#cb10-140" aria-hidden="true" tabindex="-1"></a>        ei_printf<span class="op">(</span><span class="st">"⚠️ ANOMALY DETECTED! Score: </span><span class="sc">%.3f\n</span><span class="st">"</span><span class="op">,</span> result<span class="op">.</span>anomaly<span class="op">);</span></span>
<span id="cb10-141"><a href="#cb10-141" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb10-142"><a href="#cb10-142" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb10-143"><a href="#cb10-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-144"><a href="#cb10-144" aria-hidden="true" tabindex="-1"></a>    delay<span class="op">(</span><span class="dv">1000</span><span class="op">);</span></span>
<span id="cb10-145"><a href="#cb10-145" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb10-146"><a href="#cb10-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-147"><a href="#cb10-147" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> ei_printf<span class="op">(</span><span class="at">const</span> <span class="dt">char</span> <span class="op">*</span>format<span class="op">,</span> <span class="op">...)</span> <span class="op">{</span></span>
<span id="cb10-148"><a href="#cb10-148" aria-hidden="true" tabindex="-1"></a>    <span class="at">static</span> <span class="dt">char</span> print_buf<span class="op">[</span><span class="dv">1024</span><span class="op">]</span> <span class="op">=</span> <span class="op">{</span> <span class="dv">0</span> <span class="op">};</span></span>
<span id="cb10-149"><a href="#cb10-149" aria-hidden="true" tabindex="-1"></a>    <span class="dt">va_list</span> args<span class="op">;</span></span>
<span id="cb10-150"><a href="#cb10-150" aria-hidden="true" tabindex="-1"></a>    va_start<span class="op">(</span>args<span class="op">,</span> format<span class="op">);</span></span>
<span id="cb10-151"><a href="#cb10-151" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> r <span class="op">=</span> vsnprintf<span class="op">(</span>print_buf<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>print_buf<span class="op">),</span> format<span class="op">,</span> args<span class="op">);</span></span>
<span id="cb10-152"><a href="#cb10-152" aria-hidden="true" tabindex="-1"></a>    va_end<span class="op">(</span>args<span class="op">);</span></span>
<span id="cb10-153"><a href="#cb10-153" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>r <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-154"><a href="#cb10-154" aria-hidden="true" tabindex="-1"></a>        Serial<span class="op">.</span>write<span class="op">(</span>print_buf<span class="op">);</span></span>
<span id="cb10-155"><a href="#cb10-155" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb10-156"><a href="#cb10-156" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<blockquote class="blockquote">
<p>The complete code is available on the <a href="https://github.com/Mjrovai/XIAO-ESP32S3-Sense/tree/main/XIAOML_Kit_code/motion_class_ad_inference">Lab’s GitHub</a>.</p>
</blockquote>
<p>Now you should try your movements, seeing the result of the inference of each class on the images:</p>
<p> <img src="./images/png/inf-idle.png" class="img-fluid" style="width:90.0%" data-fig-align="center"></p>
<p> <img src="./images/png/inf-ter.png" class="img-fluid" style="width:90.0%" data-fig-align="center"></p>
<p> <img src="./images/png/inf-lift.png" class="img-fluid" style="width:90.0%" data-fig-align="center"></p>
<p> <img src="./images/png/inf-mar.png" class="img-fluid" style="width:90.0%" data-fig-align="center"></p>
<p>And, of course, some “anomaly”, for example, putting the XIAO upside-down. The anomaly score will be over 0.5:</p>
<p> <img src="./images/png/inf-ano.png" class="img-fluid" style="width:90.0%" data-fig-align="center"></p>
</section>
<section id="post-prossessing" class="level2">
<h2 class="anchored" data-anchor-id="post-prossessing">Post-Prossessing</h2>
<p>Now that we know the model is working, we suggest modifying the code to see the result with the Kit completely offline (disconnected from the PC and powered by a battery, a power bank, or an independent 5V power supply).</p>
<p>The idea is that if a specific movement is detected, a corresponding message will appear on the OLED display.</p>
<p><img src="./images/png/inf-oled.png" class="img-fluid"></p>
<p>The modified inference code to have the OLED display is available on the <a href="https://github.com/Mjrovai/XIAO-ESP32S3-Sense/tree/main/XIAOML_Kit_code/motion_class_ad_inference_oled">Lab’s GitHub</a>.</p>
</section>
<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">Summary</h2>
<p>This lab demonstrated how to build a complete motion classification system using the XIAOML Kit’s built-in LSM6DS3TR-C IMU sensor. Key achievements include:</p>
<p><strong>Technical Implementation:</strong></p>
<ul>
<li>Utilized the integrated 6-axis IMU for motion sensing</li>
<li>Collected labeled training data for four transportation scenarios</li>
<li>Implemented spectral feature extraction for time-series analysis</li>
<li>Deployed a neural network classifier optimized for microcontroller inference</li>
<li>Added anomaly detection for identifying unusual movements</li>
</ul>
<p><strong>Machine Learning Pipeline:</strong></p>
<ul>
<li>Data collection directly from embedded sensors</li>
<li>Feature engineering using frequency domain analysis</li>
<li>Model training and optimization in Edge Impulse</li>
<li>Real-time inference on resource-constrained hardware</li>
<li>Performance monitoring and validation</li>
</ul>
<p><strong>Practical Applications:</strong> The techniques learned apply directly to real-world scenarios, including:</p>
<ul>
<li>Asset tracking and logistics monitoring</li>
<li>Predictive maintenance for machinery</li>
<li>Human activity recognition</li>
<li>Vehicle and equipment monitoring</li>
<li>IoT sensor networks for smart cities</li>
</ul>
<p><strong>Key Learnings:</strong></p>
<ul>
<li>Working with IMU coordinate systems and sensor fusion</li>
<li>Balancing model accuracy with inference speed on edge devices</li>
<li>Implementing robust data collection and preprocessing pipelines</li>
<li>Deploying machine learning models to embedded systems</li>
<li>Integrating multiple sensors (IMU + display) for complete solutions</li>
</ul>
<p>The integration of motion classification with the XIAOML Kit demonstrates how modern embedded systems can perform sophisticated AI tasks locally, enabling real-time decision-making without reliance on the cloud. This approach is fundamental to the future of edge AI in industrial IoT, autonomous systems, and smart device applications.</p>
</section>
<section id="resources" class="level2">
<h2 class="anchored" data-anchor-id="resources">Resources</h2>
<ul>
<li><a href="https://github.com/Mjrovai/XIAO-ESP32S3-Sense/tree/main/XIAOML_Kit_code">XIAOML KIT Code</a></li>
<li><a href="../../../content/shared/dsp_spectral_features_block/dsp_spectral_features_block.html">DSP Spectral Features</a></li>
<li><a href="https://studio.edgeimpulse.com/public/750061/live">Edge Impulse Project</a></li>
<li><a href="https://colab.research.google.com/github/Mjrovai/Arduino_Nicla_Vision/blob/main/Motion_Classification/Edge_Impulse_Spectral_Features_Block.ipynb">Edge Impulse Spectral Features Block Colab Notebook</a></li>
<li><a href="https://docs.edgeimpulse.com/">Edge Impulse Documentation</a></li>
<li><a href="https://docs.edgeimpulse.com/docs/edge-impulse-studio/processing-blocks/spectral-features">Edge Impulse Spectral Features</a></li>
<li><a href="https://github.com/Seeed-Studio/Seeed_Arduino_LSM6DS3">Seeed Studio LSM6DS3 Library</a></li>
</ul>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
          // target, if specified
          link.setAttribute("target", "_blank");
          // default icon
          link.classList.add("external");
      }
    }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../../../content/xiaoml_kit/kws/kws.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Keyword Spotting (KWS)</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../../../content/shared/dsp_spectral_features_block/dsp_spectral_features_block.html" class="pagination-link">
        <span class="nav-page-text">DSP Spectral Features</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">Written and edited by Prof.&nbsp;Marcelo Rovai (UNIFEI University)</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">This book was built with <a href="https://quarto.org/">Quarto</a>.</div>
  </div>
</footer>



</body></html>